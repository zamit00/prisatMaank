<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>סימולטור פרישת מענקים</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
      padding: 20px;
      max-width: 1200px;
      margin: 50px auto;
    }

    .screen-section {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      display: none;
    }

    .screen-section.visible {
      display: block;
      
    }

    /* התאמה למסכים גדולים - Flexbox */
    @media (min-width: 769px) {
        .screen-section.visible {
      width: 500px;
      
    }
      .app-container {
        flex-direction: row;
        gap: 50px;
      }
      .input-section {
        max-width: 600px;
      }
      .section1and2 {
        display: flex;
        flex-direction: row;
        gap: 30px;
        max-width: 1000px;
      }
      .chart-container {
        height: 300px;  
      }
      #tableSection {
        width: 1200px;
      }
    }

    h2 {
      color: #2c3e50;
      font-size: 2.2em;
      margin-bottom: 30px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
      text-align: center;
    }

    /* שדות קלט */
    .input-group {
      margin-bottom: 25px;
    }

    .input-group label {
      display: block;
      font-size: 1.1em;
      color: #34495e;
      margin-bottom: 8px;
    }

    .styled-input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #ecf0f1;
      border-radius: 8px;
      font-size: 1.2em;
      color: #2c3e50;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .styled-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
      background-color: #f8f9fa;
    }

    .styled-input::placeholder {
      color: #bdc3c7;
    }

    /* כפתורים */
    .styled-button {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.3em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      margin-top: 30px;
    }
    
    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .button-group .styled-button {
        width: 100%;
        margin-top: 0;
    }

    .styled-button.secondary {
      background-color: #95a5a6;
    }

    .styled-button:hover {
      background-color: #2980b9;
    }
    
    .styled-button.secondary:hover {
      background-color: #7f8c8d;
    }

    .styled-button:active {
      transform: translateY(2px);
    }

    .input-hint {
      display: block;
      font-size: 0.9em;
      color: #95a5a6;
      margin-top: 5px;
    }

    /* עיצוב מסך התוצאות */
    .results-summary {
      width: 100%;
    }

    .chart-container {
      background-color: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }
    
    .result-box {
      background-color: #ecf0f1;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .result-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .result-label {
      font-size: 1.1em;
      color: #555;
      font-weight: bold;
    }

    .result-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #3498db;
    }

    .highlighted {
      background-color: #3498db;
    }

    .highlighted .result-label, .highlighted .result-value {
      color: #ffffff;
    }
    
    /* עיצוב מסך פריסה */
    .data-saving{
        background-color: #e1ece3;
        color: rgb(87, 21, 219);
         border-radius: 8px;
        margin-bottom: 20px;
    }
    .data-summary {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .data-summary p, .data-saving p{
        font-size: 1.1em;
        margin: 5px 0;
    }

    .data-summary strong {
        color: #34495e;
    }

    .distribution-options {
        margin-top: 20px;
    }

    .option-group {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .option-group:hover {
        background-color: #f0f8ff;
        border-color: #3498db;
    }

    .option-group.active {
        background-color: #e6f7ff;
        border-color: #3498db;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.2);
    }

    .radio-label {
        display: flex;
        align-items: center;
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
        cursor: pointer;
    }

    .radio-label input[type="radio"] {
        margin-left: 10px;
        transform: scale(1.3);
        cursor: pointer;
    }
    
    .input-group label {
      font-size: 1em; /* התאמת גודל הפונט לשדה בתוך הקבוצה */
    }
    
    .hidden {
        display: none !important;
    }
    
    /* עיצוב טבלה - רספונסיביות */
    .results-table-container {
      overflow-x: auto;
      margin-top: 30px;
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      text-align: right;
    }
    
    .results-table th, .results-table td {
      padding: 15px;
      border: 1px solid #e0e0e0;
      white-space: nowrap;
      vertical-align: middle;
    }

    .results-table td.input-cell {
        padding: 5px;
    }

    .results-table td .income-input {
        width: 120px;
        padding: 8px;
        text-align: right;
    }

    .results-table thead th {
      background-color: #3498db;
      color: #fff;
      font-weight: bold;
      text-align: center;
    }
    
    .results-table tbody tr:nth-child(even) {
      background-color: #f7f7f7;
    }
    
    .results-table tbody tr:hover {
      background-color: #eaf6ff;
    }
    
    .table-totals {
      font-weight: bold;
      background-color: #ecf0f1;
    }
    
    .select-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 25px;
    }
    .select-group label {
        margin-bottom: 0;
    }

  </style>
</head>
<body>

<div class="app-container">
    <div class="section1and2">
        <section id="inputSection" class="screen-section visible">
    <h2 style="white-space: nowrap;">נתונים לחישוב מענק פרישה</h2>
    <form id="retirementForm">  
        <div class="input-group">
            <label for="grantAmount" style="font-weight: bold;">סך מענק פרישה למשיכה</label>
            <input type="text" id="grantAmount" name="grantAmount" placeholder="לדוגמה: 1,500,000" class="styled-input" data-type="currency" required>
            <span class="input-hint">סה״כ מענקי הפרישה למשיכה בלבד, ללא מענקי פרישה שביקשנו לגביהם רצף קצבה</span>
        </div>
        <div class="input-group">
            <label for="grantAmount" style="font-weight: bold;">סך הכנסות בשנת הפרישה</label>
            <input type="text" id="incomeOfThisYear" name="grantAmount" placeholder="לדוגמה: 350,000" class="styled-input" data-type="currency" required>
            <span class="input-hint">סה״כ ההכנסות ללא מענק הפרישה למשיכה</span>
        </div>
      
      <div class="input-group">
        <label for="retirementDate" style="font-weight: bold;">תאריך הפרישה</label>
        <input type="date" id="retirementDate" name="retirementDate" class="styled-input" required>
        <span class="input-hint">תאריך הפרישה הוא היום האחרון של העבודה. בהפסקת עבודה עקב מוות, יש לציין את תאריך הפטירה. תאריך הפרישה כפי שמופיע בטופס 161 בחלק ג</span>
      </div>
      
      <div class="input-group">
        <label for="seniorityYears" style="font-weight: bold;">תקופת ותק בעבודה (שנים וחלקי שנים)</label>
        <input type="number" id="seniorityYears" name="seniorityYears" placeholder="לדוגמה: 25.5" class="styled-input" step="0.1" min="0" required>
        <span class="input-hint">יש למלא את מספר ימי העבודה מתאריך אצל המעביד מתאריך ההתחלה ועד תאריך הפרישה (כולל יום הפרישה), בניכוי ימי חופשה ללא תשלום (חל״ת), מספר הימים מחולק ל-365 נותן את תקופת העבודה בשנים וחלקי שנים.</span>
    </div>

      <div class="input-group">
        <label for="lastSalary" style="font-weight: bold;">משכורת חודשית אחרונה</label>
        <input type="text" id="lastSalary" name="lastSalary" placeholder="לדוגמה: 20,000" class="styled-input" data-type="currency" required>
        <span class="input-hint">הכנסת עבודה למעט תשלומים שניתנו לעובד לכיסוי הוצאותיו ולמעט שויי שימוש ברכב צמוד, ״משכורת חודש״ אצל עובד יומי היא השכר הממוצע בשניים עשר החודשים שקדמו לפיטורים.</span>
    </div>

     <!-- <button id="submit" type="submit" class="styled-button">המשך</button>-->
    </form>
        </section>

        <section id="resultsSection" class="screen-section visible">
    <div class="results-summary">
        <h2>סיכום נתוני פרישה</h2>
        
        <div class="result-box">
            <span class="result-label">תקרת פטור שנתית</span>
            <span id="annualExemptionLimit" class="result-value"></span>
        </div>

        <div class="result-box">
            <span class="result-label">מענק פטור</span>
            <span id="exemptGrant" class="result-value"></span>
        </div>

        <div class="result-box highlighted" >
            <span class="result-label">מענק חייב במס</span>
            <span id="taxableGrant" class="result-value"></span>
        </div>
    </div>
    
    <div class="chart-container">
        <canvas id="grantChart"></canvas>
    </div>
    
    <div class="button-group" style="margin-top: 22%;">
        <!-- <button id="backToInput" class="styled-button secondary">חזור</button> -->
        <button id="continueToDistribution" class="styled-button">המשך לפריסה</button>
    </div>
        </section>
    </div>  
  <section id="distributionSection" class="screen-section">
    <h2>אפשרויות פריסת מענק</h2>

    <div class="data-summary">
        <p><strong>שנות ותק:</strong> <span id="summarySeniorityYears"></span> שנים</p>
        <p><strong>תאריך פרישה:</strong> <span id="summaryRetirementDate"></span></p>
        <p><strong>שנות פריסה קדימה אפשריות:</strong> <span id="futureYears"></span></p>
        <p><strong>שנות פריסה אחורה אפשריות:</strong> <span id="pastYears"></span></p>
    </div>
    
    <div class="input-group">
        <p>בחר מין:</p>
        <label class="radio-label">
            <input type="radio" name="gender" value="male" checked>
            גבר - 2.25 נקודות זיכוי מס
        </label>
        <label class="radio-label">
            <input type="radio" name="gender" value="female">
            אישה - 2.75 נקודות זיכוי מס
        </label>
    </div>
    
    <div class="select-group">
        <label for="distributionYearsSelect">בחר מספר שנות פריסה:</label>
        <select id="distributionYearsSelect" class="styled-input"></select>
    </div>

    <div class="distribution-options">
        <div class="option-group">
            <label class="radio-label">
                <input id="forward" type="radio" name="distributionType" value="forward" checked onchange="updateYearsOptions()">
                פריסה קדימה
            </label>
        </div>
        
        <div class="option-group forward-options">
            <p>בחר שנת התחלה:</p>
            <label class="radio-label">
                <input type="radio" name="forwardStartYear" value="current" checked >
                בשנה הנוכחית
            </label>
            <label class="radio-label">
                <input type="radio" name="forwardStartYear" value="next" >
                בשנה העוקבת
            </label>
            
            <!-- <div id="nextYearIncome" class="input-group hidden">
                <label for="currentYearIncome">הכנסה חייבת במס בשנת העזיבה</label>
                <input type="text" id="currentYearIncome" class="styled-input" data-type="currency" placeholder="לדוגמה: 120,000">
            </div> -->
        </div>
        
        <div class="option-group">
            <label class="radio-label">
                <input type="radio" name="distributionType" value="backward"  onchange="updateYearsOptions()">
                פריסה אחורה
            </label>
        </div>
    </div>
    
    <div class="button-group">
        <button id="backToResults" class="styled-button secondary">חזור</button>
        <button id="calculateFinal" class="styled-button">חשב פריסה</button>
    </div>
  </section>
  
  <section id="tableSection" class="screen-section">
    <h2>טבלת פריסה מפורטת</h2>
    <div class="results-table-container">
        <table class="results-table">
            <thead>
                <tr>
                    <th>שנת מס</th>
                    <th>סכום פריסה</th>
                    <th>הכנסות צפויות</th>
                    <th>סה"כ הכנסה</th>
                    <th>סך המס</th>
                    <th>מס על המענק</th>
                    <th>שיעור המס על המענק</th>
                </tr>
            </thead>
            <tbody id="distributionTableBody"></tbody>
            <tfoot>
                <tr id="tableTotalsRow" class="table-totals">
                    <td>סה"כ</td>
                    <td id="totalDistributionSum"></td>
                    <td id="totalIncomeSum"></td>
                    <td id="totalCombinedSum"></td>
                    <td id="totalTaxSum"></td>
                    <td id="totalGrantTaxSum"></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <section class="data-saving" style="margin-top: 20px;">
        <p style="margin-top: 20px; font-size: 0.9em; color: #555;"> מס ללא פריסה = <span id="taxWithoutDistribution"></span>  </p>
        <p style="margin-top: 20px; font-size: 0.9em; color: #555;"> מס כולל פריסה = <span id="taxWithDistribution"></span>  </p>
        <p style="margin-top: 20px; font-size: 0.9em; color: #555;"> חיסכון במס בפריסה = <span id="taxSavings"></span>  </p>
    </section>
    <div class="button-group">
        <button id="backToDistribution" class="styled-button secondary">חזור</button>
        <button id="startOver" class="styled-button">התחל מחדש</button>
    </div>
  </section>
  
</div>

<script>
  // נתונים קבועים
  const TAX_FREE_GRANT_PER_YEAR = 13750;
  const CREDIT_POINT_VALUE = 2904;
  const INCOME_TAX_BRACKETS = [
    { limit: 81480, rate: 0.10 },
    { limit: 116760, rate: 0.14 },
    { limit: 187440, rate: 0.20 },
    { limit: 260520, rate: 0.31 },
    { limit: 542160, rate: 0.35 },
    { limit: 697920, rate: 0.47 },
    { limit: Infinity, rate: 0.50 }
  ];
  
  let taxableGrantAmount = 0;
  let distributionYearsCount = 0;
  let distributionType = 'forward';
  let forwardStartYearType = 'current';
  let retirementYear = 0;
  let gender = 'male';

  // פונקציית עזר לחישוב מס לפי מדרגות
  function calculateTax(income, gender) {
    let tax = 0;
    let remainingIncome = income;
    const creditPoints = gender === 'male' ? 2.25 : 2.75;
    const creditPointAmount = creditPoints * CREDIT_POINT_VALUE;

    for (let i = 0; i < INCOME_TAX_BRACKETS.length; i++) {
      const bracket = INCOME_TAX_BRACKETS[i];
      const prevLimit = i > 0 ? INCOME_TAX_BRACKETS[i - 1].limit : 0;
      const currentBracketIncome = Math.min(remainingIncome, bracket.limit - prevLimit);
      
      if (currentBracketIncome <= 0) break;
      
      tax += currentBracketIncome * bracket.rate;
      remainingIncome -= currentBracketIncome;
    }
    
    return Math.max(0, tax - creditPointAmount);
  }
  
  // פונקציית עזר לפורמט כספי
  function formatCurrency(amount) {
    if (isNaN(amount) || amount < 0) return '0 ₪';
    return new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', minimumFractionDigits: 0 }).format(amount);
  }

  // פונקציית עדכון הטבלה וחישוב מחדש
  function updateTable() {
    // sumCurrentYearIncome += incomeInRetirementYear;
    const rows = document.querySelectorAll('#distributionTableBody tr');
    let newTotalTaxSum = 0;
    let newTotalGrantTaxSum = 0;
    let newTotalCombinedSum = 0;
    let totalDistributionSum = 0;
    let newTotalIncomeSum = 0;
    const retirementDateInput = document.getElementById('retirementDate');
    const retirementDate = retirementDateInput.value;
    const retirementYear = new Date(retirementDate).getFullYear();
    

   if(Number(rows[0].children[0].textContent)===Number(retirementYear)){
            rows[0].children[2].children[0].value=Number(document.getElementById('incomeOfThisYear').value.replace(/,/g, '')) || 0;    
            rows[0].children[2].children[0].disabled=true;
        }else{   
            rows[0].children[2].children[0].disabled=false;
        }
    rows.forEach(row => {
        const distributionPerYear = taxableGrantAmount / distributionYearsCount;
        const incomeInput = row.children[2].querySelector('input');
        let sumCurrentYearIncome = Number(document.getElementById('incomeOfThisYear').value.replace(/,/g, '')) || 0; 
        const incomeThisYear = parseFloat(incomeInput.value) || 0;
        let newTotalIncomeSum = 0;
        
        const combinedIncome = distributionPerYear + incomeThisYear;
        const taxThisYear = calculateTax(combinedIncome, gender);
        const taxOnIncome = calculateTax(incomeThisYear, gender);
        const taxOnGrant = Math.max(0, taxThisYear - taxOnIncome);
        const grantTaxRate = distributionPerYear > 0 ? (taxOnGrant / distributionPerYear) * 100 : 0;
        
        row.children[1].textContent = formatCurrency(distributionPerYear);
        row.children[3].textContent = formatCurrency(combinedIncome);
        row.children[4].textContent = formatCurrency(taxThisYear);
        row.children[5].textContent = formatCurrency(taxOnGrant);
        row.children[6].textContent = `${grantTaxRate.toFixed(2)}%`;

        totalDistributionSum += distributionPerYear;
        newTotalIncomeSum += incomeThisYear;
        newTotalTaxSum += taxThisYear;
        newTotalGrantTaxSum += taxOnGrant;
        newTotalCombinedSum += combinedIncome;
    });
        
    document.getElementById('totalDistributionSum').textContent = formatCurrency(totalDistributionSum);
    document.getElementById('totalIncomeSum').textContent = formatCurrency(newTotalIncomeSum);
    document.getElementById('totalCombinedSum').textContent = formatCurrency(newTotalCombinedSum);
    document.getElementById('totalTaxSum').textContent = formatCurrency(newTotalTaxSum);
    document.getElementById('totalGrantTaxSum').textContent = formatCurrency(newTotalGrantTaxSum);

    document.getElementById('taxWithoutDistribution').textContent = formatCurrency(taxForOneYear()) ;
    document.getElementById('taxWithDistribution').textContent = formatCurrency(newTotalTaxSum);
    document.getElementById('taxSavings').textContent = formatCurrency(taxForOneYear() - newTotalTaxSum);

    
  }
  
  // פונקציה שמפעילה את החישובים ועדכון המסך הראשון
  function updateResultsSection() {
    const grantAmount = parseFloat(document.getElementById('grantAmount').value.replace(/,/g, ''));
    const lastSalary = parseFloat(document.getElementById('lastSalary').value.replace(/,/g, ''));
    const seniorityYears = parseFloat(document.getElementById('seniorityYears').value);

    const annualExemptionLimit = Math.min(lastSalary * 1.5, TAX_FREE_GRANT_PER_YEAR);
    const totalExemptGrant = seniorityYears * annualExemptionLimit;
    const taxableGrant = grantAmount - totalExemptGrant;
    taxableGrantAmount = taxableGrant;

    document.getElementById('annualExemptionLimit').textContent = formatCurrency(annualExemptionLimit);
    document.getElementById('exemptGrant').textContent = formatCurrency(totalExemptGrant);
    document.getElementById('taxableGrant').textContent = formatCurrency(taxableGrant);
    
    // יצירת/עדכון הגרף
    const chartCanvas = document.getElementById('grantChart');
    if (chartCanvas.chart) {
        chartCanvas.chart.destroy();
    }

    const ctx = chartCanvas.getContext('2d');
    const chartData = {
        labels: ['מענק חייב במס', 'מענק פטור ממס'],
        datasets: [{
            data: [taxableGrant, totalExemptGrant],
            backgroundColor: ['#e74c3c', '#2ecc71'],
            hoverOffset: 4
        }]
    };
    
    const myChart = new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.label}: ${formatCurrency(context.raw)}`
                    }
                },
                datalabels: {
                    color: '#fff',
                    formatter: (value) => formatCurrency(value),
                    font: { weight: 'bold', size: 14 },
                    anchor: 'center',
                    align: 'center'
                }
            }
        }
    });
    chartCanvas.chart = myChart;
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ---- רכיבי HTML ----
    const inputSection = document.getElementById('inputSection');
    const resultsSection = document.getElementById('resultsSection');
    const distributionSection = document.getElementById('distributionSection');
    const tableSection = document.getElementById('tableSection');

    const grantAmountInput = document.getElementById('grantAmount');
    const seniorityYearsInput = document.getElementById('seniorityYears');
    const lastSalaryInput = document.getElementById('lastSalary');
    const retirementDateInput = document.getElementById('retirementDate');
    
    const form = document.getElementById('retirementForm');
    const backToInputBtn = document.getElementById('backToInput');
    const continueToDistributionBtn = document.getElementById('continueToDistribution');
    const backToResultsBtn = document.getElementById('backToResults');
    const calculateFinalBtn = document.getElementById('calculateFinal');
    const backToDistributionBtn = document.getElementById('backToDistribution');
    const startOverBtn = document.getElementById('startOver');
    
    const forwardOptions = document.querySelector('.forward-options');
    //const nextYearIncomeInput = document.getElementById('nextYearIncome');
    const distributionTableBody = document.getElementById('distributionTableBody');
    const distributionYearsSelect = document.getElementById('distributionYearsSelect');
    
    // ---- לוגיקת עיצוב הקלט ----
    const currencyInputs = document.querySelectorAll('[data-type="currency"]');
    currencyInputs.forEach(input => {
      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/,/g, '');
        const formattedValue = new Intl.NumberFormat('he-IL').format(value);
        e.target.value = formattedValue;
        updateResultsSection();
      });
    });

    seniorityYearsInput.addEventListener('input', updateResultsSection);
    
    // ---- לוגיקת מעבר בין מסכים ----
    
    // מסך 1 -> 2
   /* form.addEventListener('submit', (e) => {
      e.preventDefault();
      // החישוב מתבצע כבר ב-input listeners, כאן רק מעבר בין מסכים
      //inputSection.classList.remove('visible');
      //inputSection.style.width = '500px';
      submit.style.display="none";
      resultsSection.classList.add('visible');
    });

    // מסך 2 -> 1
    backToInputBtn.addEventListener('click', () => {
        resultsSection.classList.remove('visible');
        inputSection.classList.add('visible');
        submit.style.display="block";
    });
*/
    // מסך 2 -> 3
    continueToDistributionBtn.addEventListener('click', () => {
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        inputSection.classList.remove('visible');
        const seniorityYears = parseFloat(seniorityYearsInput.value);
        const retirementDate = retirementDateInput.value;
        retirementYear = new Date(retirementDate).getFullYear();
        let maxYears;
        const futureYears = Math.min(Math.round(seniorityYears / 4), 6);
        const pastYears = Math.min(Math.ceil(seniorityYears), 6);
        const retirementMonthDay = new Date(retirementDate).getMonth() * 100 + new Date(retirementDate).getDate();
        if(retirementMonthDay <830) { 
           forwardOptions.classList.add('hidden');
       } 
        distributionYearsSelect.innerHTML = '';
        for (let i = 1; i <= futureYears; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i + ' שנים';
            distributionYearsSelect.appendChild(option);
        }
        distributionYearsCount = parseInt(distributionYearsSelect.value);

        document.getElementById('summarySeniorityYears').textContent = seniorityYears;
        document.getElementById('summaryRetirementDate').textContent = new Date(retirementDate).toLocaleDateString('he-IL');
        document.getElementById('futureYears').textContent = futureYears;
        document.getElementById('pastYears').textContent = pastYears;
        
        resultsSection.classList.remove('visible');
        distributionSection.classList.add('visible');
    });

    // מסך 3 -> 2
    backToResultsBtn.addEventListener('click', () => {
        distributionSection.classList.remove('visible');
        resultsSection.classList.add('visible');
        inputSection.classList.add('visible');
    });
    
    // ---- לוגיקת אפשרויות פריסה ----
    document.querySelectorAll('input[name="gender"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            gender = e.target.value;
        });
    });

    distributionYearsSelect.addEventListener('change', (e) => {
        distributionYearsCount = parseInt(e.target.value);
    });

    document.querySelectorAll('input[name="distributionType"]').forEach(radio => {
        

        radio.addEventListener('change', (e) => {
            const retirementDateInput = document.getElementById('retirementDate');
            const retirementDate = retirementDateInput.value;
            const retirementMonthDay = new Date(retirementDate).getMonth() * 100 + new Date(retirementDate).getDate();
            distributionType = e.target.value;
                forwardOptions.classList.toggle('hidden', distributionType !== 'forward');
                //nextYearIncomeInput.classList.add('hidden');
            document.querySelectorAll('.option-group').forEach(group => group.classList.remove('active'));
            e.target.closest('.option-group').classList.add('active');
             if(retirementMonthDay <830) {
              forwardOptions.classList.add('hidden');
              }
        });

    });

    document.querySelectorAll('input[name="forwardStartYear"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            forwardStartYearType = e.target.value;
            //nextYearIncomeInput.classList.toggle('hidden', forwardStartYearType !== 'next');
        });
    });
    
    // ---- מסך 3 -> 4: בניית הטבלה וחישובים סופיים ----
    calculateFinalBtn.addEventListener('click', () => {
        distributionTableBody.innerHTML = '';
        const incomeInRetirementYear = parseFloat(document.getElementById('incomeOfThisYear').value.replace(/,/g, '')) || 0;
        const distributionPerYear = taxableGrantAmount / distributionYearsCount;

        for (let i = 0; i < distributionYearsCount; i++) {
            const row = document.createElement('tr');
            
            let year;
            if (distributionType === 'forward') {
                year = forwardStartYearType === 'current' ? retirementYear + i : retirementYear + 1 + i;
            } else { // אחורה
                year = retirementYear - i;
            }
            
            const initialIncomeThisYear = (distributionType === 'forward' && forwardStartYearType === 'next' && i === 0) ? 0 : 0;
            
            row.innerHTML = `
                <td>${year}</td>
                <td>${formatCurrency(distributionPerYear)}</td>
                <td class="input-cell">
                    <input type="number" class="income-input styled-input" value="${initialIncomeThisYear}" min="0" step="1000">
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            `;
            distributionTableBody.appendChild(row);
        }

        updateTable(); // חישוב ראשוני של הטבלה

        // אזינה לשינויים בשדות הקלט בטבלה
        document.querySelectorAll('.income-input').forEach(input => {
            input.addEventListener('input', updateTable);
        });

        distributionSection.classList.remove('visible');
        tableSection.classList.add('visible');
    });

    // מסך 4 -> 3
    backToDistributionBtn.addEventListener('click', () => {
        tableSection.classList.remove('visible');
        distributionSection.classList.add('visible');
    });

    // חזרה להתחלה
    startOverBtn.addEventListener('click', () => {
        taxForOneYear();return;
        tableSection.classList.remove('visible');
        inputSection.classList.add('visible');
        resultsSection.classList.add('visible');
        document.getElementById('retirementForm').reset();
        document.getElementById('annualExemptionLimit').textContent = "";
        document.getElementById('exemptGrant').textContent = "";
        document.getElementById('taxableGrant').textContent = "";
    });
  });

  function updateYearsOptions(){

    const seniorityYears = parseFloat(document.getElementById('seniorityYears').value);
    const futureYears = Math.min(Math.round(seniorityYears / 4), 6);
    const pastYears = Math.min(Math.ceil(seniorityYears), 6);
    let maxYears;
    if (document.getElementById('forward').checked) {
       maxYears = futureYears;
    } else {
          maxYears = pastYears;
    }
    
    distributionYearsSelect.innerHTML = '';
    for (let i = 1; i <= maxYears; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i + ' שנים';
        distributionYearsSelect.appendChild(option);
    }
    distributionYearsCount = parseInt(distributionYearsSelect.value);
  }
  function taxForOneYear(){
    let sumCurrentYearIncome = Number(document.getElementById('incomeOfThisYear').value.replace(/,/g, '')) || 0;  
    let sumGrantIncome=Number(document.getElementById('grantAmount').value.replace(/,/g, ''));
    let sumTotalIncome=sumCurrentYearIncome+sumGrantIncome;
    
   return Number(calculateTax(sumTotalIncome)-calculateTax(sumCurrentYearIncome)) || 0;
  }
</script>
</body>
</html>