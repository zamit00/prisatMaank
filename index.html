<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<title>סימולטור פריסת מענק פרישה — סעיף 8ג</title>
<style>
  :root{
    --bg:#0b1020; --card:#111831; --primary:#4cc9f0; --accent:#b5179e;
    --ok:#2dd4bf; --warn:#f59e0b; --danger:#ef4444; --muted:#94a3b8; --text:#e6e9ef;
    --ring: rgba(76,201,240,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 600px at 80% -100px, #1b2547, transparent 60%), var(--bg);
    font-family:system-ui, "Segoe UI", "Heebo", "Rubik", Arial, sans-serif; color:var(--text);
  }
  .container{max-width:1100px;margin:0 auto;padding:20px}
  @media (max-width:768px){.container{padding:12px}}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:42px;height:42px;border-radius:12px;background:
      radial-gradient(circle at 65% 35%, #7ee8fa, transparent 40%),
      radial-gradient(circle at 35% 65%, #eec0c6, transparent 40%),
      linear-gradient(135deg, #3a0ca3, #480ca8 45%, #560bad);
    box-shadow:0 10px 25px rgba(0,0,0,.25), inset 0 0 12px rgba(255,255,255,.15);
  }
  h1{font-size:1.3rem;margin:0 0 2px}
  @media (max-width:768px){h1{font-size:1.05rem}}
  
  .subtitle{color:var(--muted);font-size:1.35rem;background-color: #465076;text-align: center;
border-radius: 5px;padding: 5px;}
  @media (max-width:768px){.subtitle{font-size:1rem;padding:8px}}
  
  .adkani{font-size:1.05rem;color:#d4e0ff;margin:4px 0 0;font-weight:500}
  @media (max-width:768px){.adkani{font-size:.85rem;margin:2px 0 0}}

  /* Stepper */
  .steps{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:16px 0 10px}
  @media (max-width:768px){.steps{gap:3px;margin:12px 0 8px}}
  
  .step{
    position:relative;padding:10px 12px;border-radius:14px;background:#0f1630;border:1px solid #1c254d;
    color:#a6b1cc;text-align:center;font-size:.9rem;user-select:none;
  }
  @media (max-width:768px){.step{padding:8px 4px;font-size:.65rem;border-radius:8px}}
  
  .step.active{background:linear-gradient(180deg,#131c3f,#0f1630);color:#eaf1ff;
    font-weight: bold; border-color:#30407a;box-shadow:0 0 0 3px var(--ring)}
  @media (max-width:768px){.step.active{box-shadow:0 0 0 2px var(--ring)}}
  
  .step:before{content:"";position:absolute;inset:auto 0 -6px 0;margin:auto;width:50%;height:4px;border-radius:4px;background:transparent;transition:.25s}
  .step.active:before{background:linear-gradient(90deg,var(--primary),var(--accent))}

  /* Cards / Panels */
  .panel{
    position:relative;overflow:hidden;border-radius:18px;background:linear-gradient(180deg,#6a81cc 0%, #213d9a 100%);
    border:1px solid #1b264d;box-shadow:0 10px 30px rgba(0,0,0,.35);font-weight: bold;
    padding:18px;display:none;transform:translateY(12px) scale(.98);pointer-events:none;transition:opacity .35s, transform .35s;
  }
  @media (max-width:768px){.panel{padding:12px;border-radius:12px}}
  
  .panel.show{display:block;transform:translateY(0) scale(1);pointer-events:auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  
  label{display:block;font-size:.9rem;color:#c2c9db;margin-bottom:6px}
  @media (max-width:768px){label{font-size:.85rem}}
  
  .input{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid #243058;background:white;color:black;font-size:1rem;
    outline:none;transition:.2s;
  }
  @media (max-width:768px){.input{padding:10px;font-size:.9rem}}
  
  .input:focus{border-color:#3b4ea3;box-shadow:0 0 0 3px var(--ring)}
  .help{font-size:.82rem;color:#9aa7c7;margin-top:6px}
  @media (max-width:768px){.help{font-size:.75rem}}
  
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  @media (max-width:768px){.row{gap:6px}}
  
  .btn{
    padding:12px 16px;border:none;border-radius:12px;background:linear-gradient(90deg,#3a86ff,#4cc9f0);
    color:white;font-weight:600;cursor:pointer;transition:transform .08s ease, box-shadow .2s;
    box-shadow:0 8px 18px rgba(76,201,240,.2);font-size:1rem;
  }
  @media (max-width:768px){.btn{padding:10px 12px;font-size:.9rem}}
  
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#1a2246;color:#eaf1ff;border:1px solid #2a366e;box-shadow:none}
  .btn.warn{background:linear-gradient(90deg,#f97316,#f59e0b)}
  .btn.ghost{background:transparent;border:1px dashed #3b4ea3;color:#b8c7ff}
  .stack{display:flex;gap:10px;flex-wrap:wrap}
  @media (max-width:768px){.stack{gap:6px}}
  
  .spacer{height:8px}
  .pill{padding:8px 12px;border-radius:999px;background:#10193a;border:1px solid #243058;color:#dbe4ff;font-size:.88rem}
  @media (max-width:768px){.pill{padding:6px 10px;font-size:.8rem}}
  
  .note{font-size:.9rem;color:#aab6d6}
  @media (max-width:768px){.note{font-size:.8rem}}
  
  .mono{font-variant-numeric:tabular-nums;text-align: center;}
  .kpi{
    display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px
  }
  @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
  @media (max-width:500px){.kpi{grid-template-columns:1fr;gap:8px}}
  
  .kpi .card{
    background:#0e1634;border:1px solid #1d2952;border-radius:16px;padding:14px;min-height:84px
  }
  @media (max-width:768px){.kpi .card{padding:10px;min-height:70px;border-radius:12px}}
  
  .title{white-space: nowrap;}
  @media (max-width:768px){.title{white-space:normal}}
  
  .kpi .title{font-size:.85rem;color:#a8b3d4}
  @media (max-width:768px){.kpi .title{font-size:.75rem}}
  
  .kpi .value{font-size:1.15rem;margin-top:6px;font-weight:700}
  @media (max-width:768px){.kpi .value{font-size:.95rem;margin-top:4px}}

  /* Table */
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  thead th{
    position:sticky;top:0;background:#0f183a;border-bottom:1px solid #26305d;padding:10px;font-size:.92rem;color:#c9d3f3;z-index:1
  }
  @media (max-width:768px){
    thead th{padding:6px 4px;font-size:.7rem}
  }
  tbody td{border-bottom:1px dashed #1f2a57;padding:10px;color:#e7ecff}
  @media (max-width:768px){
    tbody td{padding:6px 4px;font-size:.75rem}
  }
  tbody tr:hover{background:#0c1432}
  .td-num{font-variant-numeric:tabular-nums;text-align:left;direction:ltr}
  @media (max-width:768px){
    .td-num{font-size:.7rem}
  }
  .input-num{
    width:100%;padding:10px;border-radius:10px;border:1px solid #22305c;background:#0a1230;color:#eaf1ff;direction:ltr;text-align:left
  }
  @media (max-width:768px){
    .input-num{padding:6px;font-size:.8rem}
  }

  /* 3D Pie (SVG illusion) */
  .pie-wrap{display:flex;gap:20px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:8px}
  @media (max-width:768px){.pie-wrap{gap:12px}}
  
  .pie{
    width:280px;max-width:100%;
    filter: drop-shadow(0 14px 24px rgba(0,0,0,.45));
    transform: perspective(900px) rotateX(18deg);
  }
  @media (max-width:768px){.pie{width:200px}}
  
  .legend{display:flex;flex-direction:column;gap:8px}
  @media (max-width:768px){.legend{gap:6px}}
  
  .legend .item{display:flex;align-items:center;gap:8px}
  @media (max-width:768px){.legend .item{gap:6px;font-size:.85rem}}
  
  .swatch{width:14px;height:14px;border-radius:4px;border:1px solid rgba(255,255,255,.15)}
  @media (max-width:768px){.swatch{width:12px;height:12px}}
  
  .swatch.taxable{background:linear-gradient(180deg,#f72585,#b5179e)}
  .swatch.exempt{background:linear-gradient(180deg,#34d399,#10b981)}

  /* Alerts */
  .alert{border:1px solid #33407a;background:#0d173a;border-radius:12px;padding:10px;font-size:.95rem}
  @media (max-width:768px){.alert{padding:8px;font-size:.82rem;border-radius:8px}}
  
  .alert.ok{border-color:rgba(45,212,191,.35);background:rgba(13,148,136,.08)}
  .alert.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08)}
  .alert.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}

  .footer-note{margin-top:18px;color:#93a0c2;font-size:.85rem}
  @media (max-width:768px){.footer-note{font-size:.75rem;margin-top:12px}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div>
          <h1>סימולטור פריסת מענק פרישה</h1>
          <div class="subtitle">לפי סעיף 8ג לפקודת מס הכנסה — פריסת מענקי פרישה</div>
          <h3 class="adkani">עדכני לנתוני רשות המיסים לשנת 2025</h3>
        </div>
      </div>
    </header>

    <div class="steps">
      <div class="step active" data-step="1">1. נתונים ראשוניים</div>
      <div class="step" data-step="2">2. תוצאות בסיס + פאי</div>
      <div class="step" data-step="3">3. העדפות פריסה</div>
      <div class="step" data-step="4">4. טבלת שנים,סיכום וחיסכון</div>
      <div class="step" data-step="5" style="display: none;"></div>
    </div>

    <!-- Panel 1: נתונים ראשוניים -->
    <section class="panel show" id="panel-1" aria-labelledby="p1-title">
      <h2 id="p1-title" class="subtitle">מלא/י את הנתונים הראשוניים</h2>
      <div class="grid">
        <div>
          <label>מענק פרישה למשיכה (סה"כ)</label>
          <input class="input money" id="grantTotal" inputmode="numeric" placeholder="לדוגמה: 250,000.00" 
          value="" required />
          <div class="help">סכום המענק הכולל לפני פטור/פריסה.</div>
        </div>
        <div>
          <label>שכר אחרון (חודשי ברוטו)</label>
          <input class="input money" id="lastSalary" inputmode="numeric" placeholder="לדוגמה: 12,500.00"
          value="" required/>
          <div class="help">משמש לחישוב 150%×שכר אל מול תקרת השכר.</div>
        </div>
        <div>
          <label>תאריך תחילת עבודה</label>
          <input class="input" id="startDate" type="date" required/>
          <div class="help">לצורך חישוב הוותק (כולל חלקי שנים).</div>
        </div>
        <div>
          <label>תאריך פרישה</label>
          <input class="input" id="retireDate" type="date" required />
          <div class="help">אם פרישה מ־30/09 ואילך — אפשר להתחיל פריסה בשנה העוקבת.</div>
        </div>
        <div>
          <label>הכנסות נוספות בשנת הפרישה (ללא המענק)</label>
          <input class="input money" id="firstYearIncome" inputmode="numeric" placeholder="לדוגמה: 120,000.00" 
          value="" required />
          <div class="help">משמשת להשוואה "ללא פריסה" וגם לשורה הראשונה אם מתחילים בשנה הנוכחית.</div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="stack">
        <button class="btn" id="to-step-2">המשך לתוצאות הבסיס</button>
        <button class="btn secondary" id="resetAll" onclick="resetAll()">אפס הכל</button>
        <span class="note">החישוב מתעדכן בזמן אמת; ניתן לחזור אחורה בכל שלב.</span>
      </div>

      <div class="footer-note">מדרגות מס ונקודות זיכוי נכונות לשנה הנוכחית כפי שסיפקת. ניתן לעדכן בקוד הקבועים בתחילת הסקריפט.</div>
    </section>

    <!-- Panel 2: תוצאות בסיס + פאי -->
    <section class="panel" id="panel-2">
      <h2 class="subtitle">תוצאות בסיסיות — ותק, פטור, חייב וגרף עוגה</h2>

      <div class="kpi">
        <div class="card">
          <div class="title">ותק בעבודה (שנים)</div>
          <div class="value mono" id="kpi-tenure">0.00</div>
        </div>
        <div class="card">
          <div class="title">תקרת שכר</div>
          <div class="value mono" id="kpi-basePerYear">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">מענק פטור</div>
          <div class="value mono" id="kpi-exempt">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">מענק חייב</div>
          <div class="value mono" id="kpi-taxable">0.00 ש"ח</div>
        </div>
      </div>

      <div class="pie-wrap">
        <svg class="pie" viewBox="0 0 200 200" id="pieSvg" aria-label="חלוקת מענק: פטור / חייב"></svg>
        <div class="legend">
          <div class="item"><span class="swatch exempt"></span> פטור</div>
          <div class="item"><span class="swatch taxable"></span> חייב</div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="alert ok" id="capNote" style="display:none"></div>

      <div class="spacer"></div>
      <div class="stack">
        <button class="btn secondary goBack" data-back="1">חזרה</button>
        <button class="btn" id="to-step-3">המשך להעדפות פריסה</button>
      </div>
    </section>

    <!-- Panel 3: העדפות פריסה -->
    <section class="panel" id="panel-3">
      <h2 class="subtitle">בחר/י העדפות פריסה ונקודות זיכוי</h2>

      <div class="grid">
        <div>
          <label>מין ונקודות זיכוי</label>
          <div class="row">
            <label class="pill"><input type="radio" name="gender" value="male" checked /> גבר — 2.25 נק'</label>
            <label class="pill"><input type="radio" name="gender" value="female" /> אישה — 2.75 נק'</label>
          </div>
          <div class="help">שווי נקודת זיכוי: 2,904 ש"ח. נלקח בחשבון בכל חישוב מס.</div>
        </div>
        <div>
          <label>כיוון פריסה</label>
          <div class="row">
            <label class="pill"><input id="forward" type="radio" name="direction" value="forward" checked onchange="addYearsOptions()" /> קדימה</label>
            <label class="pill"><input id="backward" type="radio" name="direction" value="backward" onchange="addYearsOptions()" /> אחורה</label>
          </div>
          <div class="help">מקסימום כולל: 6 שנים, או לפי הזכאות המוגבלת (הנמוך).</div>
        </div>

        <div id="startOptionWrap" style="display:none">
          <label>אם פרישה מ־30/09 ואילך — התחלת הפריסה</label>
          <div class="row">
            <label class="pill"><input type="radio" name="startWhen" value="current" checked /> בשנה הנוכחית</label>
            <label class="pill"><input type="radio" name="startWhen" value="next" /> בשנה העוקבת</label>
          </div>
          <div class="help">חל רק בפריסה קדימה.</div>
        </div>

        <div>
          <label>שנות פריסה (בחר בין 1 למקסימום האפשרי)</label>
          <select class="input" id="yearsSelect"></select>
          <div class="help" id="eligibilityText">זכאות תתעדכן אוטומטית.</div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="stack">
        <button class="btn secondary goBack" data-back="2">חזרה</button>
        <button class="btn" id="to-step-4">המשך לטבלת שנים</button>
      </div>
    </section>

    <!-- Panel 4: טבלת שנים -->
    <section class="panel" id="panel-4">
      <h2 class="subtitle">פרטי הפריסה לפי שנים — הזן הכנסות נוספות לכל שנה</h2>

      <div class="alert warn" id="autoFillFirstNote" style="display:none">
        לשנה הראשונה הוזנה אוטומטית ההכנסה מהמסך הראשון (כי התחלה בשנה הנוכחית). ניתן לעדכן ידנית.
      </div>

      <div class="kpi">
        <div class="card">
          <div class="title">חלק מענק לשנה</div>
          <div class="value mono" id="kpi-partPerYear">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">מדרגות מס פעילות</div>
          <div class="value mono">מותאם לשנה הנוכחית</div>
        </div>
        <div class="card">
          <div class="title">נקודות זיכוי לשנה</div>
          <div class="value mono" id="kpi-credits">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">מס על מלוא המענק בשנה הראשונה (ללא פריסה)</div>
          <div class="value mono" id="kpi-tax-no-spread">0.00 ש"ח</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div style="overflow:auto;border:1px solid #22305c;border-radius:12px">
        <table id="spreadTable" aria-label="טבלת פריסת המענק">
          <thead>
            <tr>
              <th style="width:90px">שנה</th>
              <th>חלק מענק לשנה</th>
              <th>הכנסה נוספת</th>
              <th>סך הכנסה</th>
              <th>סך המס הכולל</th>
              <th>מס על חלק המענק</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="spacer"></div>
      <div class="stack" style="justify-content: space-between; flex-wrap: wrap;gap: 10px; ">
        <button class="btn secondary goBack" data-back="3">חזרה</button>
        <input class="btn" id="equalSum" type="checkbox" value="" onchange="equalSum()"><span style="padding: 5px 0px;">סכום אחיד</span></button>
        <input class="input-num" id="sumEqualSum" inputmode="numeric" placeholder="100,000.00"
        style="max-width: 100px;" oninput="equalSum()"/>

      </div>
    </section>

    <!-- Panel 5: סיכום וחיסכון במס -->
    <section class="panel" id="panel-5">
      <h2 class="subtitle">סיכום וחיסכון במס</h2>

      <div class="kpi">
        <div class="card">
          <div class="title">מס על מלוא המענק ללא פריסה (שנה ראשונה)</div>
          <div class="value mono" id="sum-tax-no-spread">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">סך מס על חלקי המענק בכל השנים (עם פריסה)</div>
          <div class="value mono" id="sum-tax-with-spread">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">חיסכון במס בזכות הפריסה</div>
          <div class="value mono" id="sum-savings">0.00 ש"ח</div>
        </div>
        <div class="card">
          <div class="title">שנות פריסה שנבחרו</div>
          <div class="value mono" id="sum-years">0</div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="alert ok">
        הערה: החישוב מבוסס על בסיס נתונים שסיפקת. לצרכי תכנון מס סופי מומלץ לוודא מול הוראות החוק העדכניות ולשקול ייעוץ מס.
      </div>

      <div class="spacer"></div>
      <div class="stack">
        <button class="btn secondary goBack" data-back="4" style="display: none;">חזרה</button>
        <button class="btn ghost" id="restart">התחל מחדש</button>
      </div>
    </section>

  </div>

<script>
const INCOME_TAX_BRACKETS = [
    { limit: 84120, rate: 0.10 },
    { limit: 120720, rate: 0.14 },
    { limit: 193800, rate: 0.20 },
    { limit: 269280, rate: 0.31 },
    { limit: 560280, rate: 0.35 },
    { limit: 721560, rate: 0.47 },
    { limit: Infinity, rate: 0.50 }
  ];
const CREDIT_POINTS = { male: 2.25, female: 2.75 };
const DEFAULT_SALARY_CAP = 13750;
const CREDIT_POINT_VALUE = 2904;

function fmtMoney(v){
  if(isNaN(v) || v==null) v=0;
  return v.toLocaleString('he-IL',{minimumFractionDigits:2,maximumFractionDigits:2})+" ש\"ח";
}
function fmtNum(v){
  if(isNaN(v) || v==null) v=0;
  return v.toLocaleString('he-IL',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function parseNum(el){
  const raw = (typeof el==="string")? el : el.value;
  const clean = raw.replace(/[^\d.-]/g,"");
  return parseFloat(clean)||0;
}

function calcTax(income, gender){
  let tax=0, prev=0;
  for(const b of INCOME_TAX_BRACKETS){
    if(income>prev){
      const taxable = Math.min(income,b.limit)-prev;
      tax += taxable*b.rate;
      prev = b.limit;
    } else break;
  }
  const credits = CREDIT_POINTS[gender]*CREDIT_POINT_VALUE;
  return Math.max(0,tax-credits);
}

function showPanel(n){
  document.querySelectorAll(".panel").forEach(p=>p.classList.remove("show"));
  document.querySelector("#panel-"+n).classList.add("show");
  if(n===4) {
    document.querySelector("#panel-4").classList.add("show")
    document.querySelector("#panel-5").classList.add("show");
  };

  document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
  document.querySelector('.step[data-step="'+n+'"]').classList.add("active");
}

function calcBase(){
  const grantTotal = parseNum(document.querySelector("#grantTotal"));
  const lastSalary = parseNum(document.querySelector("#lastSalary"));
  const salaryCap = DEFAULT_SALARY_CAP;
  const start = new Date(document.querySelector("#startDate").value);
  const retire = new Date(document.querySelector("#retireDate").value);
  const tenureYears = (retire-start)/(1000*60*60*24*365);
  const basePerYear = Math.min(lastSalary*1.5, salaryCap);
  const exempt = Math.min(grantTotal, tenureYears*basePerYear);
  const taxable = Math.max(0, grantTotal-exempt);

  document.querySelector("#kpi-tenure").textContent = fmtNum(tenureYears);
  document.querySelector("#kpi-basePerYear").textContent = fmtMoney(basePerYear);
  document.querySelector("#kpi-exempt").textContent = fmtMoney(exempt);
  document.querySelector("#kpi-taxable").textContent = fmtMoney(taxable);

  drawPie(exempt,taxable);
  return {grantTotal,lastSalary,salaryCap,tenureYears,basePerYear,exempt,taxable};
}

function drawPie(exempt,taxable){
  const total = exempt+taxable||1;
  const pct = taxable/total;
  const angle = pct*360;
  const r=100, x = r+ r*Math.sin(angle*Math.PI/180), y = r- r*Math.cos(angle*Math.PI/180);
  const large = pct>0.5?1:0;
  let d = `M100,100 L100,0 A100,100 0 ${large} 1 ${x},${y} Z`;
  if(pct===0) d="";
  const svg=document.querySelector("#pieSvg");
  svg.innerHTML="";
  if(exempt>0){
    const pathEx=`<circle r="100" cx="100" cy="100" fill="url(#gradEx)" />`;
    svg.innerHTML+=pathEx;
  }
  if(taxable>0){
    const pathTx=`<path d="${d}" fill="url(#gradTx)" />`;
    svg.innerHTML+=pathTx;
  }
  const defs=`<defs>
    <linearGradient id="gradEx" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#34d399"/><stop offset="100%" stop-color="#10b981"/></linearGradient>
    <linearGradient id="gradTx" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#f72585"/><stop offset="100%" stop-color="#b5179e"/></linearGradient>
  </defs>`;
  svg.innerHTML=defs+svg.innerHTML;
}

function buildTable(data,gender,years,direction,startNext){
  const tbody=document.querySelector("#spreadTable tbody");
  tbody.innerHTML="";
  const partPerYear = data.taxable/years;
  document.querySelector("#kpi-partPerYear").textContent=fmtMoney(partPerYear);
  document.querySelector("#kpi-credits").textContent=fmtMoney(CREDIT_POINTS[gender]*CREDIT_POINT_VALUE);

  const firstIncome=parseNum(document.querySelector("#firstYearIncome"));
  const firstYear=new Date(document.querySelector("#retireDate").value).getFullYear();
  
    
  let startYear=(direction==="forward")? (startNext?firstYear+1:firstYear):(firstYear);
  for(let i=0;i<years;i++){
  const y=(direction==="forward")? startYear+i : startYear-i;
  const tr=document.createElement("tr");
  const tdYear=`<td>${y}</td>`;
  const tdPart=`<td class="td-num">${fmtMoney(partPerYear)}</td>`;
  let tdIncome;
  if(y===firstYear){
    tdIncome=`<td>
      <input class="input-num" data-year="${y}" 
             value="${fmtNum(firstIncome)}" 
             oninput="calcTable(0,0,0,0,0)" />
    </td>`;
  } else{    
    tdIncome=`<td>
            <input class="input-num" data-year="${y}" 
            value="0" 
            oninput="calcTable(0,0,0,0,0)" />
            </td>`;
  }
  const tdTot=`<td class="td-num" id="tot-${y}">0</td>`;
  const tdTax=`<td class="td-num" id="tax-${y}">0</td>`;
  const tdTaxPart=`<td class="td-num" id="taxPart-${y}">0</td>`;
  tr.innerHTML=tdYear+tdPart+tdIncome+tdTot+tdTax+tdTaxPart;
  tbody.appendChild(tr);
  }
}

function calcTable(data,gender,years,direction,startNext){
   if(!data){
    gender=document.querySelector("input[name=gender]:checked").value;
    direction=document.querySelector("input[name=direction]:checked").value;
    startNext=(direction==="forward" && new Date(document.querySelector("#retireDate").value).getMonth()>=9 && document.querySelector("input[name=startWhen]:checked").value==="next");
    years=parseInt(document.querySelector("#yearsSelect").value)||1;
    data=calcBase();
   }

  const partPerYear = data.taxable/years;
  let sumTaxWithSpread=0;
  document.querySelectorAll("#spreadTable tbody tr").forEach(tr=>{
    const y=tr.children[0].textContent;
    const income=parseNum(tr.querySelector("input"));
    const total=income+partPerYear;
    const taxWith=calcTax(total,gender);
    const taxWithout=calcTax(income,gender);
    const diff=taxWith-taxWithout;
    document.querySelector("#tot-"+y).textContent=fmtMoney(total);
    document.querySelector("#tax-"+y).textContent=fmtMoney(taxWith);
    document.querySelector("#taxPart-"+y).textContent=fmtMoney(diff);
    sumTaxWithSpread+=diff;
  });
  const noSpread=calcTax(data.taxable+parseNum(document.querySelector("#firstYearIncome")),gender)-calcTax(parseNum(document.querySelector("#firstYearIncome")),gender);
  document.querySelector("#kpi-tax-no-spread").textContent=fmtMoney(noSpread);
  document.querySelector("#sum-tax-no-spread").textContent=fmtMoney(noSpread);
  document.querySelector("#sum-tax-with-spread").textContent=fmtMoney(sumTaxWithSpread);
  document.querySelector("#sum-savings").textContent=fmtMoney(noSpread-sumTaxWithSpread);
  document.querySelector("#sum-years").textContent=years;
}

function resetAll(){
  document.querySelectorAll("input").forEach(i=>i.value="");
  document.querySelector("#yearsSelect").innerHTML="";
  document.querySelector("#spreadTable tbody").innerHTML="";
  document.querySelector("#autoFillFirstNote").style.display="none";
  document.querySelector("#capNote").style.display="none";
  showPanel(1);
}

document.querySelector("#to-step-2").onclick=()=>{
    const requiredFields = ["#grantTotal", "#lastSalary", "#startDate", "#retireDate", "#firstYearIncome"];
    for (const selector of requiredFields) {
        const el = document.querySelector(selector);
        if (!el.value) {
            Swal.fire({
            title: "<span style='color: white; font-size: 16px;'> נדרש למלא את כל השדות</span>" ,
            width: "30%", 
            icon: "warning",
            timer: 2000, 
            showConfirmButton: false,
            timerProgressBar: true, 
            background: "#5a6aa3",
            customClass: {
            popup: 'swal2-center-custom'
          }       
         });
            el.focus();
            return;
        }
    }
    const d=calcBase();showPanel(2);
};
document.querySelector("#to-step-3").onclick=()=>{showPanel(3);addYearsOptions();};
document.querySelector("#to-step-4").onclick=()=>{
  const retire = new Date(document.querySelector("#retireDate").value);
  const retirementMonthDay = new Date(retire).getMonth() * 100 + new Date(retire).getDate();
  const gender=document.querySelector("input[name=gender]:checked").value;
  const direction=document.querySelector("input[name=direction]:checked").value;
  const startNext=(direction==="forward" && retirementMonthDay>=830 && document.querySelector("input[name=startWhen]:checked").value==="next");
  const years=parseInt(document.querySelector("#yearsSelect").value)||1;
  const d=calcBase();
  buildTable(d,gender,years,direction,startNext);
  calcTable(d,gender,years,direction,startNext);
  showPanel(4);
};

document.querySelectorAll(".goBack").forEach(b=>b.onclick=()=>{showPanel(b.dataset.back);
});
document.querySelector("#restart").onclick=()=>{location.reload();};

function addYearsOptions(){
  const tenureYears=Number(document.querySelector("#kpi-tenure").textContent) || 0;
  const retire = new Date(document.querySelector("#retireDate").value);

  let maxYears=Math.min(6,Math.round(tenureYears/4));
  if(document.getElementById("backward").checked){
    maxYears=Math.min(6,Math.floor(tenureYears));
  }
  const sel=document.querySelector("#yearsSelect");
  sel.innerHTML="";
  for(let i=1;i<=maxYears;i++){
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=i;
    sel.appendChild(opt);
  }
  document.querySelector("#eligibilityText").textContent=`זכאות לפריסה לפי ותק: עד ${maxYears} שנים.`;
  const retirementMonthDay = new Date(retire).getMonth() * 100 + new Date(retire).getDate();
  if(retirementMonthDay>=830 && document.querySelector("input[name=direction]:checked").value==="forward"){
    document.querySelector("#startOptionWrap").style.display="block";
  } else {
    document.querySelector("#startOptionWrap").style.display="none";
  }
  const direction=document.querySelector("input[name=direction]:checked").value;
  if(direction==="forward" && retire.getMonth()<9){
    document.querySelector("#autoFillFirstNote").style.display="block";
  } else {
    document.querySelector("#autoFillFirstNote").style.display="none";
  }
}
function equalSum(){
    const retire = new Date(document.querySelector("#retireDate").value);
    equalSumChecked = document.querySelector("#equalSum").checked;
    if(equalSumChecked){
        const equalSumValue = parseNum(document.querySelector("#sumEqualSum"));
        document.querySelectorAll("#spreadTable tbody tr").forEach(tr=>{
            if(tr.firstChild.textContent!==retire.getFullYear().toString()){
                tr.querySelector("input").value=fmtNum(equalSumValue);
            } 
        });
       calcTable(0,0,0,0,0);
    } 
    else{
        document.querySelectorAll("#spreadTable tbody tr").forEach(tr=>{
             if(tr.firstChild.textContent!==retire.getFullYear().toString()){
                tr.querySelector("input").value="0";
             }
        });
       calcTable(0,0,0,0,0);
    }
}
</script>
<div style="text-align: center;position: relative;bottom: 10px;">כל הזכויות שמורות לחגי זך</div>
</body>
</html>
